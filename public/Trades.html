<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trade Center</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .trade-section {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    .player-card {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    .form-section, .offers-section {
      margin-top: 40px;
    }
    button {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Trade Center</h1>
  <header>
    <a href="../index.html">Player List</a>
    <a href="../homepage.html">Homepage</a>
    <button onclick="logout()">Logout</button>
  </header>

  <div class="trade-section" id="playerList"></div>

  <div class="form-section">
    <h2>Offer a Trade</h2>
    <form id="tradeForm">
      <label for="yourOperator">Your Operator:</label>
      <select id="yourOperator" required></select><br /><br />

      <label for="targetPlayer">Target Player:</label>
      <select id="targetPlayer" required></select><br /><br />

      <label for="targetOperator">Their Operator:</label>
      <select id="targetOperator" required></select><br /><br />

      <button type="submit">Send Trade Offer</button>
    </form>
    <div id="message"></div>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbxK9Q_SgyqXMESycU3WL0XTHzU4WSF5T5hBDgl7Xji5S0ZqVg-9e6FS9DMTPm_G4CO_5Q/exec";
    let loggedInUser = localStorage.getItem("loggedInUser") || null;
if (!loggedInUser) {
  alert("You must be logged in to trade.");
  window.location.href = "../login.html";
}
allPlayersData[p.username.toLowerCase()] = p.operators;
loggedInUser = loggedInUser.toLowerCase();

    let allPlayersData = {};

    async function loadPlayers() {
      try {
        const res = await fetch(`${scriptURL}?type=username`);
        const usernames = await res.json();

        const playerPromises = usernames.map(async (user) => {
          const userRes = await fetch(`${scriptURL}?sheet=${user}`);
          const ops = await userRes.json();
          return { username: user, operators: ops.map(op => op.Operator) };
        });

        const playerData = await Promise.all(playerPromises);
        allPlayersData = {};
        playerData.forEach(p => allPlayersData[p.username] = p.operators);

        renderPlayerCards();
        populateTradeDropdowns();
      } catch (err) {
        console.error("Error loading players:", err);
      }
    }

    function renderPlayerCards() {
      const playerList = document.getElementById("playerList");
      playerList.innerHTML = "";
      for (const [username, operators] of Object.entries(allPlayersData)) {
        const card = document.createElement("div");
        card.className = "player-card";
        card.innerHTML = `<h3>${username}</h3><ul>${operators.map(op => `<li>${op}</li>`).join("")}</ul>`;
        playerList.appendChild(card);
      }
    }

    function populateTradeDropdowns() {
      const yourSelect = document.getElementById("yourOperator");
      const playerSelect = document.getElementById("targetPlayer");
      const targetSelect = document.getElementById("targetOperator");

      yourSelect.innerHTML = "";
      playerSelect.innerHTML = "";
      targetSelect.innerHTML = "";

      if (allPlayersData[loggedInUser]) {
        allPlayersData[loggedInUser].forEach(op => {
          yourSelect.innerHTML += `<option value="${op}">${op}</option>`;
        });
      }

      for (const player in allPlayersData) {
        if (player !== loggedInUser) {
          playerSelect.innerHTML += `<option value="${player}">${player}</option>`;
        }
      }

      playerSelect.addEventListener("change", () => {
        const selectedPlayer = playerSelect.value;
        targetSelect.innerHTML = "";
        if (allPlayersData[selectedPlayer]) {
          allPlayersData[selectedPlayer].forEach(op => {
            targetSelect.innerHTML += `<option value="${op}">${op}</option>`;
          });
        }
      });
    }

    document.getElementById("tradeForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const yourOperator = document.getElementById("yourOperator").value;
      const targetPlayer = document.getElementById("targetPlayer").value;
      const targetOperator = document.getElementById("targetOperator").value;

      const payload = {
        type: "tradeRequest",
        username: loggedInUser,
        yourOperator,
        targetPlayer,
        targetOperator
      };

      try {
        const res = await fetch(scriptURL, {
          method: "POST",
          body: JSON.stringify(payload),
          headers: { "Content-Type": "application/json" }
        });
        const result = await res.text();
        document.getElementById("message").textContent = result;
      } catch (err) {
        console.error("Failed to submit trade request:", err);
        document.getElementById("message").textContent = "Failed to send trade.";
      }
    });

    function logout() {
      localStorage.removeItem("loggedInUser");
      window.location.href = "../login.html";
    }

    loadPlayers();
  </script>
</body>
</html>
