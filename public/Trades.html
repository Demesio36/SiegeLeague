<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trade Center</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .trade-section {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    .player-card {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    .form-section, .offers-section, .requests-section {
      margin-top: 40px;
    }
    button {
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h1>Trade Center</h1>
  <header>
    <a href="../index.html">Player List</a>
    <a href="../homepage.html">Homepage</a>
    <button onclick="logout()">Logout</button>
  </header>

  <div class="trade-section" id="playerList"></div>

  <div class="form-section">
    <h2>Offer a Trade</h2>
    <form id="tradeForm">
      <label for="yourOperator">Your Operator:</label>
      <select id="yourOperator" required></select><br /><br />

      <label for="targetPlayer">Target Player:</label>
      <select id="targetPlayer" required></select><br /><br />

      <label for="targetOperator">Their Operator:</label>
      <select id="targetOperator" required></select><br /><br />

      <button type="submit">Send Trade Offer</button>
    </form>
    <div id="message"></div>
  </div>

  <div class="requests-section">
    <h2>Your Requests</h2>
    <ul id="yourRequests"></ul>
  </div>

  <div class="offers-section">
    <h2>Offers Sent to You</h2>
    <ul id="yourOffers"></ul>
  </div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbycGz3VqwZd15ihYzb1TunF8RretMdU1GJKQCCpHPsgxt2jR_y1Eu0andfRNxJWrPq0Ew/exec';
    const proxyURL = '/.netlify/functions/proxy-trade';

    let loggedInUser = localStorage.getItem("loggedInUser") || null;
    if (!loggedInUser) {
      alert("You must be logged in to trade.");
      window.location.href = "../login.html";
    }
    loggedInUser = loggedInUser.toLowerCase();

    let allPlayersData = {};

    async function loadPlayers() {
      const res = await fetch(`${scriptURL}?type=username`);
      const usernames = await res.json();

      const operatorsRes = await fetch(`${scriptURL}?type=all`);
      const allStats = await operatorsRes.json();

      usernames.forEach(username => {
        const ops = allStats[username] ? allStats[username].map(row => row.Operator) : [];
        allPlayersData[username.toLowerCase()] = ops;
      });

      renderPlayerCards();
      populateTradeDropdowns();
    }

    function renderPlayerCards() {
      const playerList = document.getElementById("playerList");
      playerList.innerHTML = "";
      for (const [username, operators] of Object.entries(allPlayersData)) {
        const card = document.createElement("div");
        card.className = "player-card";
        card.innerHTML = `<h3>${username}</h3><ul>${operators.map(op => `<li>${op}</li>`).join("")}</ul>`;
        playerList.appendChild(card);
      }
    }

    function populateTradeDropdowns() {
      const yourSelect = document.getElementById("yourOperator");
      const playerSelect = document.getElementById("targetPlayer");
      const targetSelect = document.getElementById("targetOperator");

      yourSelect.innerHTML = "";
      playerSelect.innerHTML = "";
      targetSelect.innerHTML = "";

      if (allPlayersData[loggedInUser]) {
        allPlayersData[loggedInUser].forEach(op => {
          yourSelect.innerHTML += `<option value="${op}">${op}</option>`;
        });
      }

      for (const player in allPlayersData) {
        if (player !== loggedInUser) {
          playerSelect.innerHTML += `<option value="${player}">${player}</option>`;
        }
      }

      playerSelect.addEventListener("change", () => {
        const selectedPlayer = playerSelect.value;
        targetSelect.innerHTML = "";
        if (allPlayersData[selectedPlayer]) {
          allPlayersData[selectedPlayer].forEach(op => {
            targetSelect.innerHTML += `<option value="${op}">${op}</option>`;
          });
        }
      });
    }

    document.getElementById("tradeForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const yourOperator = document.getElementById("yourOperator").value;
      const targetPlayer = document.getElementById("targetPlayer").value;
      const targetOperator = document.getElementById("targetOperator").value;

      const payload = {
        type: "tradeRequest",
        username: loggedInUser,
        yourOperator,
        targetPlayer,
        targetOperator
      };

      try {
        const res = await fetch(proxyURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const msg = await res.text();
        document.getElementById("message").textContent = msg;
        loadTrades();
      } catch (err) {
        console.error("Failed to submit trade request:", err);
        document.getElementById("message").textContent = "Failed to submit trade.";
      }
    });

    async function loadTrades() {
      try {
        const res = await fetch(`${scriptURL}?type=trades`);
        const trades = await res.json();

        const yourList = document.getElementById("yourRequests");
        const offersList = document.getElementById("yourOffers");
        yourList.innerHTML = "";
        offersList.innerHTML = "";

        trades.forEach(trade => {
          const tradeText = `${trade.username} wants to trade ${trade.yourOperator} for ${trade.targetOperator} from ${trade.targetPlayer} â€” [${trade.status}]`;

          if (trade.username.toLowerCase() === loggedInUser) {
            const li = document.createElement("li");
            li.textContent = tradeText;
            yourList.appendChild(li);
          } else if (trade.targetPlayer.toLowerCase() === loggedInUser) {
            const li = document.createElement("li");
            li.textContent = tradeText;

            const acceptBtn = document.createElement("button");
            acceptBtn.textContent = "Accept";
            acceptBtn.onclick = () => {
              alert("This would notify admin to manually process the trade.");
              li.remove();
            };

            const denyBtn = document.createElement("button");
            denyBtn.textContent = "Decline";
            denyBtn.onclick = () => li.remove();

            li.appendChild(acceptBtn);
            li.appendChild(denyBtn);
            offersList.appendChild(li);
          }
        });
      } catch (err) {
        console.error("Failed to load trades:", err);
      }
    }

    function logout() {
      localStorage.removeItem("loggedInUser");
      window.location.href = "../login.html";
    }

    window.onload = () => {
      loadPlayers();
      loadTrades();
    };
  </script>
</body>
</html>
