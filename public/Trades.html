<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trade Center</title>

  
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .trade-section {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    .player-card {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    .form-section {
      margin-top: 40px;
    }
    .offers-section {
      margin-top: 40px;
    }
    button {
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <h1>Trade Center</h1>
<header>
    <a href="../index.html">Player List</a>
    <a href="../homepage.html">Homepage</a>
    <button onclick="logout()">Logout</button>
  </header>
  <div class="trade-section" id="playerList"></div>

  <div class="form-section">
    <h2>Offer a Trade</h2>
    <form id="tradeForm">
      <label for="yourOperator">Your Operator:</label>
      <select id="yourOperator" required></select><br /><br />

      <label for="targetPlayer">Target Player:</label>
      <select id="targetPlayer" required></select><br /><br />

      <label for="targetOperator">Their Operator:</label>
      <select id="targetOperator" required></select><br /><br />

      <button type="submit">Send Trade Offer</button>
    </form>
    <div id="message"></div>
  </div>

  <div class="offers-section">
    <h2>Trade Offers Sent to You</h2>
    <ul id="incomingTrades"></ul>
  </div>

  <script>
  const loggedInUser = localStorage.getItem("loggedInUser");
  const playersUrl = "/data/players.json";
  const tradesUrl = "/data/trades.json";

  let allPlayersData = {};
  let allTrades = [];

  async function loadPlayers() {
    const res = await fetch(playersUrl);
    allPlayersData = await res.json();
    renderPlayerCards();
    populateTradeDropdowns();
  }

  async function loadTrades() {
    const res = await fetch(tradesUrl);
    allTrades = await res.json();
    renderIncomingTrades();
  }

  function renderPlayerCards() {
    const playerList = document.getElementById("playerList");
    playerList.innerHTML = "";
    for (const [username, operators] of Object.entries(allPlayersData)) {
      const card = document.createElement("div");
      card.className = "player-card";
      card.innerHTML = `<h3>${username}</h3><ul>${operators.map(op => `<li>${op}</li>`).join("")}</ul>`;
      playerList.appendChild(card);
    }
  }

  function populateTradeDropdowns() {
    const yourSelect = document.getElementById("yourOperator");
    const playerSelect = document.getElementById("targetPlayer");
    const targetSelect = document.getElementById("targetOperator");

    yourSelect.innerHTML = "";
    playerSelect.innerHTML = "";
    targetSelect.innerHTML = "";

    if (allPlayersData[loggedInUser]) {
      allPlayersData[loggedInUser].forEach(op => {
        const opt = document.createElement("option");
        opt.value = op;
        opt.textContent = op;
        yourSelect.appendChild(opt);
      });
    }

    for (const player in allPlayersData) {
      if (player !== loggedInUser) {
        const opt = document.createElement("option");
        opt.value = player;
        opt.textContent = player;
        playerSelect.appendChild(opt);
      }
    }

    playerSelect.addEventListener("change", () => {
      const selectedPlayer = playerSelect.value;
      targetSelect.innerHTML = "";
      if (allPlayersData[selectedPlayer]) {
        allPlayersData[selectedPlayer].forEach(op => {
          const opt = document.createElement("option");
          opt.value = op;
          opt.textContent = op;
          targetSelect.appendChild(opt);
        });
      }
    });
  }

  document.getElementById("tradeForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const yourOperator = document.getElementById("yourOperator").value;
    const targetPlayer = document.getElementById("targetPlayer").value;
    const targetOperator = document.getElementById("targetOperator").value;

    const isFreeOpTrade = targetPlayer.toLowerCase() === "free ops";
    const trade = {
      username: loggedInUser,
      yourOperator,
      targetPlayer,
      targetOperator,
      accepted: isFreeOpTrade,
      timestamp: new Date().toISOString()
    };

    document.getElementById("message").textContent = isFreeOpTrade ?
      "Free operator acquired immediately!" :
      "Trade offer submitted.";

    // Post trade to Netlify function
    await fetch("/.netlify/functions/trade-offer", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(trade)
    });

    await loadTrades();
  });

  function renderIncomingTrades() {
    const incoming = allTrades.filter(t => t.targetPlayer === loggedInUser && !t.accepted);
    const list = document.getElementById("incomingTrades");
    list.innerHTML = "";

    incoming.forEach(trade => {
      const li = document.createElement("li");
      li.textContent = `${trade.username} wants to trade their ${trade.yourOperator} for your ${trade.targetOperator}`;

      const acceptBtn = document.createElement("button");
      acceptBtn.textContent = "Accept";
      acceptBtn.onclick = async () => {
        await fetch("/.netlify/functions/trade-accept", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(trade)
        });
        await loadPlayers();
        await loadTrades();
      };

      const denyBtn = document.createElement("button");
      denyBtn.textContent = "Deny";
      denyBtn.onclick = () => list.removeChild(li);

      li.appendChild(acceptBtn);
      li.appendChild(denyBtn);
      list.appendChild(li);
    });
  }

  loadPlayers();
  loadTrades();
</script>

</body>
</html>
